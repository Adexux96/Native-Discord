<Page
    x:Class="NativeDiscord.Views.FriendsListPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:NativeDiscord.Views"
    xmlns:models="using:NativeDiscord.Models"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{StaticResource DiscordBackgroundPrimary}">

    <Page.Resources>
        <Style x:Key="FriendsTabStyle" TargetType="RadioButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource DiscordTextNormal}"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="RootBorder" Background="{TemplateBinding Background}" CornerRadius="{TemplateBinding CornerRadius}" Padding="{TemplateBinding Padding}">
                            <ContentPresenter x:Name="ContentPresenter" Content="{TemplateBinding Content}" ContentTransitions="{TemplateBinding ContentTransitions}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup x:Name="CommonStates">
                                    <VisualState x:Name="Normal"/>
                                    <VisualState x:Name="PointerOver">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RootBorder" Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="#3F4147"/> <!-- Generic Hover -->
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="Pressed"/>
                                    <VisualState x:Name="Checked">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RootBorder" Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="#43444B"/> <!-- Active Background -->
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Foreground">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="White"/>
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DefaultTextBoxStyle" TargetType="TextBox">
             <Setter Property="BorderThickness" Value="0"/>
             <Setter Property="Background" Value="Transparent"/>
             <Setter Property="Foreground" Value="#DBDEE1"/>
        </Style>
    </Page.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <!-- Active Now Sidebar -->
            <ColumnDefinition Width="360"/>
        </Grid.ColumnDefinitions>
        
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Top Bar -->
            <RowDefinition Height="*"/>    <!-- Content -->
        </Grid.RowDefinitions>
        
        <!-- Top Bar -->
        <Border Grid.ColumnSpan="2" BorderBrush="#26272D" BorderThickness="0,0,0,1" Padding="24,12" Background="{StaticResource DiscordBackgroundPrimary}">
            <StackPanel Orientation="Horizontal" Spacing="16">
                <!-- Title -->
                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <FontIcon Glyph="&#xE716;" FontSize="24" Foreground="#80848E"/>
                    <TextBlock Text="Friends" FontWeight="Bold" FontSize="16" Foreground="{StaticResource DiscordTextNormal}" VerticalAlignment="Center"/>
                </StackPanel>
                
                <Rectangle Width="1" Height="24" Fill="#3F4147"/>
                
                <!-- Navigation Tabs -->
                <StackPanel x:Name="NavButtons" Orientation="Horizontal" Spacing="8">
                    <RadioButton x:Name="BtnOnline" Content="Online" GroupName="FriendsTab" Click="Tab_Click" IsChecked="True" Style="{StaticResource FriendsTabStyle}"/>
                    <RadioButton x:Name="BtnAll" Content="All" GroupName="FriendsTab" Click="Tab_Click" Style="{StaticResource FriendsTabStyle}"/>
                    <RadioButton x:Name="BtnPending" Content="Pending" GroupName="FriendsTab" Click="Tab_Click" Style="{StaticResource FriendsTabStyle}"/>
                    <RadioButton x:Name="BtnBlocked" Content="Blocked" GroupName="FriendsTab" Click="Tab_Click" Style="{StaticResource FriendsTabStyle}"/>
                    <Button x:Name="BtnAddFriend" Content="Add Friend" Background="#23A559" Foreground="White" BorderThickness="0" Padding="12,4" CornerRadius="4" Click="BtnAddFriend_Click"/>
                </StackPanel>
            </StackPanel>
        </Border>
        
        <!-- Tab Content -->
        <Grid Grid.Row="1" Background="{StaticResource DiscordBackgroundPrimary}">
            
            <!-- Standard List (Online, All, Pending, Blocked) -->
            <Grid x:Name="ListViewContainer">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/> <!-- Search -->
                    <RowDefinition Height="Auto"/> <!-- Header Label -->
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <!-- Search Bar -->
                <Grid Margin="30,16,30,0" Height="36">
                    <TextBox x:Name="SearchBox" PlaceholderText="Search" Style="{StaticResource DefaultTextBoxStyle}" CornerRadius="4" BorderThickness="0" Background="#1E1F22" Foreground="#DBDEE1" TextChanged="SearchBox_TextChanged"/>
                    <FontIcon Glyph="&#xE721;" Foreground="#949BA4" HorizontalAlignment="Right" Margin="0,0,8,0" FontSize="16"/>
                </Grid>

                <!-- List Header (e.g. "ONLINE - 3") -->
                <TextBlock x:Name="ListHeaderLabel" Grid.Row="1" Text="ONLINE - 0" Foreground="#949BA4" FontSize="12" FontWeight="Bold" Margin="30,24,30,8"/>

                <!-- The List -->
                <ListView Grid.Row="2" x:Name="FriendsListView" Padding="20,0" SelectionMode="Single">
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0,1"/>
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="models:Relationship">
                            <!-- Relationship wrapper doesn't have Status property, we need a converter or a ViewModel. 
                                 For now, let's use a trick: Bind to a property we will add to Relationship or handle in code-behind via binding helper?
                                 Actually, let's update DataModels to have a 'StatusText' property or similar, OR use a converter.
                                 Simplest: Logic in View? No.
                                 Let's add a helper property in Relationship class in DataModels. -->
                            <Grid Padding="10" CornerRadius="8" Background="Transparent" Height="62">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Border Top Divider -->
                                <Rectangle VerticalAlignment="Top" Height="1" Fill="#3F4147" Grid.ColumnSpan="3" Opacity="0.5"/>
                                
                                <!-- Avatar -->
                                <Grid Width="32" Height="32" Margin="0,0,12,0" VerticalAlignment="Center">
                                    <Ellipse>
                                        <Ellipse.Fill>
                                            <ImageBrush ImageSource="{x:Bind local:Converters.ToImageSource(User.AvatarUrl), Mode=OneWay}"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                    <!-- Status Dot -->
                                    <Ellipse Width="10" Height="10" Stroke="{ThemeResource ApplicationPageBackgroundThemeBrush}" StrokeThickness="2" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="-2,-2">
                                        <Ellipse.Fill>
                                            <SolidColorBrush Color="{x:Bind StatusColor, Mode=OneWay}"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                </Grid>

                                <!-- Name & Details -->
                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <TextBlock Text="{x:Bind User.DisplayName}" FontWeight="Bold" Foreground="{StaticResource DiscordTextNormal}"/>
                                        <TextBlock Text="{x:Bind User.Username}" Foreground="{StaticResource DiscordTextMuted}" Visibility="Collapsed"/> 
                                    </StackPanel>
                                    <!-- Status Text -->
                                    <TextBlock Text="{x:Bind StatusText}" Foreground="{StaticResource DiscordTextMuted}" FontSize="12"/>
                                </StackPanel>

                                <!-- Actions -->
                                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                    <Button Background="#2B2D31" BorderThickness="0" Width="36" Height="36" CornerRadius="18" Padding="0" ToolTipService.ToolTip="Message">
                                        <FontIcon Glyph="&#xE8BD;" FontSize="16" Foreground="#B5BAC1" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Button>
                                    <Button Background="#2B2D31" BorderThickness="0" Width="36" Height="36" CornerRadius="18" Padding="0" ToolTipService.ToolTip="More">
                                        <FontIcon Glyph="&#xE712;" FontSize="16" Foreground="#B5BAC1" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </Grid>
            
            <!-- Add Friend View -->
            <Grid x:Name="AddFriendView" Visibility="Collapsed" Background="{StaticResource DiscordBackgroundPrimary}" Padding="30,20">
                <Grid.RowDefinitions>
                     <RowDefinition Height="Auto"/>
                     <RowDefinition Height="Auto"/>
                     <RowDefinition Height="Auto"/>
                     <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <TextBlock Text="ADD FRIEND" FontWeight="Bold" Foreground="White" FontSize="16" Margin="0,0,0,16"/>
                
                <!-- Input Box Container - Needs to look like the screenshot (dark background, border maybe) -->
                <!-- Screenshot shows a large input area. We'll use a Border with TextBox inside. -->
                <Grid Grid.Row="2">
                     <Grid.ColumnDefinitions>
                         <ColumnDefinition Width="*"/>
                         <ColumnDefinition Width="Auto"/> <!-- Button -->
                     </Grid.ColumnDefinitions>
                     
                     <!-- Input Area -->
                     <Border Background="#1E1F22" CornerRadius="8" BorderBrush="#1E1F22" BorderThickness="1" Padding="12,0" Height="48">
                         <TextBox x:Name="AddFriendInput" PlaceholderText="You can add friends with their Discord username." 
                                  Background="Transparent" BorderThickness="0" Foreground="#DBDEE1" VerticalAlignment="Center" 
                                  Style="{StaticResource DefaultTextBoxStyle}"/>
                     </Border>
                     
                     <!-- Send Button -->
                     <Button Grid.Column="1" Content="Send Friend Request" Background="#5865F2" Foreground="White" Margin="16,0,0,0" Height="40" CornerRadius="4" Click="SendFriendRequest_Click" FontSize="14" FontWeight="SemiBold"/>
                </Grid>
                
                <!-- Wumpus Empty State -->
                <StackPanel Grid.Row="3" VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="24">
                     <Image Source="ms-appx:///Assets/wumpus_add_friend.png" Width="220" Opacity="0.8"/>
                     <TextBlock Text="Wumpus is waiting on friends. You don't have to though!" Foreground="#949BA4" HorizontalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Grid>
        
        <!-- Active Now Sidebar -->
        <Grid Grid.Column="1" Grid.Row="1" Background="{StaticResource DiscordBackgroundPrimary}" BorderBrush="#3F4147" BorderThickness="1,0,0,0" Padding="16">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <TextBlock Text="Active Now" FontWeight="Bold" FontSize="20" Foreground="White" Margin="0,0,0,16"/>
            
            <!-- Empty State -->
            <StackPanel x:Name="ActiveNowEmptyState" Grid.Row="1" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16" Visibility="Visible">
                 <TextBlock Text="It's quiet for now..." FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                 <TextBlock Text="When a friend starts an activity, like playing a game or hanging out on voice, we'll show it here!" 
                            Foreground="#949BA4" TextWrapping="Wrap" TextAlignment="Center" Width="260"/>
            </StackPanel>
            
            <!-- Active List -->
            <ListView x:Name="ActiveNowList" Grid.Row="1" ItemsSource="{x:Bind ActiveFriends}" SelectionMode="None" Visibility="Collapsed">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Margin" Value="0,0,0,16"/> 
                        <Setter Property="MinHeight" Value="0"/>
                    </Style>
                </ListView.ItemContainerStyle>
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="models:Relationship">
                        <Grid Padding="16" Background="#2B2D31" CornerRadius="8" BorderBrush="#1F2023" BorderThickness="1">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Header Row -->
                            <Grid Grid.Row="0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Avatar -->
                                <Grid Width="32" Height="32" Margin="0,0,12,0" VerticalAlignment="Top">
                                    <Ellipse>
                                        <Ellipse.Fill>
                                            <ImageBrush ImageSource="{x:Bind local:Converters.ToImageSource(User.AvatarUrl), Mode=OneWay}"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                    <!-- Status Dot -->
                                    <Ellipse Width="10" Height="10" Stroke="#2B2D31" StrokeThickness="2" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="-2,-2">
                                        <Ellipse.Fill>
                                            <SolidColorBrush Color="{x:Bind StatusColor, Mode=OneWay}"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                </Grid>
                                
                                <!-- User Info -->
                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                    <TextBlock Text="{x:Bind User.DisplayName, FallbackValue='Unknown'}" FontWeight="Bold" Foreground="White" FontSize="14" TextTrimming="CharacterEllipsis"/>
                                    
                                    <!-- Activity Name + Time (in Header) -->
                                    <StackPanel Orientation="Horizontal" Visibility="{x:Bind ActivityVisibility, Mode=OneWay}">
                                        <TextBlock Text="{x:Bind ActivityName, Mode=OneWay}" Foreground="#B5BAC1" FontSize="12" TextTrimming="CharacterEllipsis" MaxWidth="150" FontWeight="SemiBold"/>
                                        <TextBlock Text=" - " Foreground="#B5BAC1" FontSize="12" Visibility="{x:Bind ElapsedTimeVisibility, Mode=OneWay}"/> 
                                        <TextBlock Text="{x:Bind ElapsedTime, Mode=OneWay}" Foreground="#B5BAC1" FontSize="12" Visibility="{x:Bind ElapsedTimeVisibility, Mode=OneWay}"/>
                                    </StackPanel>
                                </StackPanel>
                                
                                <!-- Header Icon (Game Icon) -->
                                <Image Grid.Column="2" Source="{x:Bind local:Converters.ToImageSource(ActivityHeaderIconUrl), Mode=OneWay}" Width="24" Height="24" VerticalAlignment="Top" Margin="8,0,0,0"/>
                            </Grid>
                            
                            <!-- Rich Presence Body (Inner Card) -->
                            <Grid Grid.Row="1" Margin="0,12,0,0" Background="#111214" CornerRadius="8" Padding="12" Visibility="{x:Bind RichPresenceCardVisibility, Mode=OneWay}">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Large Image -->
                                <Grid Grid.Column="0" Width="60" Height="60" Margin="0,0,12,0" VerticalAlignment="Top" Visibility="{x:Bind HasActivityPrimaryImage, Mode=OneWay}">
                                    <Border CornerRadius="8">
                                        <Border.Background>
                                            <ImageBrush ImageSource="{x:Bind local:Converters.ToImageSource(ActivityPrimaryImageUrl), Mode=OneWay}"/>
                                        </Border.Background>
                                    </Border>
                                    <!-- Small Image Overlay -->
                                    <Ellipse Width="20" Height="20" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="-4,-4" Stroke="#111214" StrokeThickness="2" Visibility="{x:Bind HasActivitySecondaryImage, Mode=OneWay}">
                                        <Ellipse.Fill>
                                            <ImageBrush ImageSource="{x:Bind local:Converters.ToImageSource(ActivitySecondaryImageUrl), Mode=OneWay}"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                </Grid>
                                
                                <!-- Text Info -->
                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                    <TextBlock Text="{x:Bind ActivityDetails, Mode=OneWay}" FontWeight="Bold" Foreground="#DBDEE1" FontSize="13" TextWrapping="Wrap" MaxLines="2" TextTrimming="CharacterEllipsis"/>
                                    <TextBlock Text="{x:Bind ActivityState, Mode=OneWay}" Foreground="#949BA4" FontSize="12" TextWrapping="Wrap" MaxLines="1" TextTrimming="CharacterEllipsis" Margin="0,2,0,0"/>
                                    <TextBlock Foreground="#949BA4" FontSize="12" Margin="0,2,0,0" Visibility="{x:Bind ElapsedTimeVisibility, Mode=OneWay}">
                                        <Run Text="{x:Bind ElapsedTime, Mode=OneWay}"/>
                                        <Run Text=" elapsed"/>
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>
    </Grid>
</Page>
