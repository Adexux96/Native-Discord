<Page
    x:Class="NativeDiscord.Views.ChatPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:NativeDiscord.Views"
    xmlns:controls="using:NativeDiscord.Controls"
    xmlns:models="using:NativeDiscord.Models"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Page.Resources>
        <local:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <Style x:Key="ActionButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="6"/>
            <Setter Property="Width" Value="32"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Transitions">
                <Setter.Value>
                    <TransitionCollection>
                        <EntranceThemeTransition/>
                    </TransitionCollection>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="CustomEditTextBoxStyle" TargetType="TextBox">
            <Setter Property="Background" Value="#2B2D31"/>
            <Setter Property="Foreground" Value="{StaticResource DiscordTextNormal}"/>
            <Setter Property="BorderBrush" Value="{StaticResource DiscordBackgroundTertiary}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="12,8"/>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource DiscordBackgroundPrimary}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <!-- Sidebar Column (Collapsed by default, we will toggle it) -->
            <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <Grid.RowDefinitions>
            <RowDefinition Height="48"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Channel Header -->
        <Border Grid.Row="0" BorderBrush="#26272D" BorderThickness="0,0,0,1" Padding="16,0" Background="{StaticResource DiscordBackgroundPrimary}">
             <Grid>
                 <Grid.ColumnDefinitions>
                     <ColumnDefinition Width="*"/>
                     <ColumnDefinition Width="Auto"/>
                 </Grid.ColumnDefinitions>
                 
                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <FontIcon Glyph="&#xE8BD;" FontSize="24" Foreground="#80848E" VerticalAlignment="Center" Margin="0,2,0,0"/> <!-- Hash Icon -->
                    <TextBlock x:Name="ChannelNameBlock" Text="Channel Name" FontSize="16" FontWeight="Bold" Foreground="{StaticResource DiscordTextNormal}" VerticalAlignment="Center"/>
                </StackPanel>
                
                <!-- Header Actions -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="16" VerticalAlignment="Center">
                    <Button Background="Transparent" BorderThickness="0" Padding="4" ToolTipService.ToolTip="Notification Settings">
                        <FontIcon Glyph="&#xE7ED;" Foreground="#B5BAC1" FontSize="20"/>
                    </Button>
                    <Button Background="Transparent" BorderThickness="0" Padding="4" ToolTipService.ToolTip="Pinned Messages">
                        <FontIcon Glyph="&#xE840;" Foreground="#B5BAC1" FontSize="20"/>
                    </Button>
                    <Button x:Name="ToggleSidebarButton" Background="Transparent" BorderThickness="0" Padding="4" Click="ToggleSidebarButton_Click" ToolTipService.ToolTip="Show/Hide User Profile">
                        <FontIcon Glyph="&#xE779;" Foreground="#B5BAC1" FontSize="20"/>
                    </Button>
                    <Button Background="Transparent" BorderThickness="0" Padding="4" ToolTipService.ToolTip="Inbox">
                        <FontIcon Glyph="&#xE715;" Foreground="#B5BAC1" FontSize="20"/>
                    </Button>
                    <Button Background="Transparent" BorderThickness="0" Padding="4" ToolTipService.ToolTip="Help">
                        <FontIcon Glyph="&#xE897;" Foreground="#B5BAC1" FontSize="20"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Messages List -->
        <ListView Grid.Row="1" x:Name="MessagesList" SelectionMode="None" Padding="0,0,0,16">
            <ListView.ItemTemplate>
            <DataTemplate x:DataType="local:MessageViewModel">
                <StackPanel>
                    <!-- Date Header -->
                    <Grid Visibility="{x:Bind DateHeaderVisibility, Mode=OneWay}" Margin="16,24,16,8">
                        <Grid.ColumnDefinitions>
                             <ColumnDefinition Width="*"/>
                             <ColumnDefinition Width="Auto"/>
                             <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Rectangle Grid.Column="0" Height="1" Fill="#3F4147" VerticalAlignment="Center"/>
                        <TextBlock Grid.Column="1" Text="{x:Bind DateHeaderText, Mode=OneWay}" 
                                   Foreground="#949BA4" FontSize="12" FontWeight="Bold" Margin="8,0"/>
                        <Rectangle Grid.Column="2" Height="1" Fill="#3F4147" VerticalAlignment="Center"/>
                    </Grid>

                    <Grid Padding="0,2" MinHeight="22" Margin="0,0,0,0" Background="Transparent" 
                      ToolTipService.ToolTip="{x:Bind TimestampFormatted}"
                      PointerEntered="MessageGrid_PointerEntered"
                      PointerExited="MessageGrid_PointerExited">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/> <!-- Reply Header -->
                            <RowDefinition Height="*"/>    <!-- Main Message -->
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="72"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <VisualStateManager.VisualStateGroups>
                            <VisualStateGroup x:Name="HoverStates">
                                <VisualState x:Name="Normal"/>
                                <VisualState x:Name="PointerOver">
                                    <VisualState.Setters>
                                        <Setter Target="MessageBackground.Background" Value="#06000000"/>
                                    </VisualState.Setters>
                                </VisualState>
                            </VisualStateGroup>
                        </VisualStateManager.VisualStateGroups>
                        
                        <Grid.Resources>
                            <!-- Custom MenuFlyout Styles -->
                            <Style x:Key="DiscordFlyoutPresenterStyle" TargetType="MenuFlyoutPresenter">
                                <Setter Property="Background" Value="#111214"/>
                                <Setter Property="BorderBrush" Value="#111214"/>
                                <Setter Property="CornerRadius" Value="4"/>
                                <Setter Property="Padding" Value="0,8"/>
                                <Setter Property="MinWidth" Value="220"/>
                            </Style>
                            <Style x:Key="DiscordFlyoutItemStyle" TargetType="MenuFlyoutItem">
                                <Setter Property="Foreground" Value="#B5BAC1"/>
                                <Setter Property="FontSize" Value="14"/>
                                <Setter Property="Padding" Value="12,10"/>
                                <Setter Property="CornerRadius" Value="2"/>
                                <Setter Property="Margin" Value="8,2"/>
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            </Style>
                             <Style x:Key="DiscordFlyoutSeparatorStyle" TargetType="MenuFlyoutSeparator">
                                <Setter Property="Background" Value="#2B2D31"/>
                                <Setter Property="Margin" Value="0,4"/>
                            </Style>
                            <!-- Red Item for Delete -->
                            <Style x:Key="DiscordDeleteFlyoutItemStyle" TargetType="MenuFlyoutItem" BasedOn="{StaticResource DiscordFlyoutItemStyle}">
                                <Setter Property="Foreground" Value="#DA373C"/>
                            </Style>
                        </Grid.Resources>

                        <Grid.ContextFlyout>
                            <MenuFlyout Placement="Bottom" MenuFlyoutPresenterStyle="{StaticResource DiscordFlyoutPresenterStyle}" Opened="MessageMenu_Opened">
                                <MenuFlyoutItem Text="Add Reaction" Click="ReactionMenu_Click" Style="{StaticResource DiscordFlyoutItemStyle}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE76E;" FontSize="16"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                
                                <MenuFlyoutItem Text="Reply" Click="ReplyMenu_Click" Style="{StaticResource DiscordFlyoutItemStyle}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE97A;" FontSize="16"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                
                                <MenuFlyoutItem Text="Forward" Click="ForwardMenu_Click" Style="{StaticResource DiscordFlyoutItemStyle}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE72D;" FontSize="16"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                
                                <MenuFlyoutItem x:Name="EditMenuItem" Text="Edit Message" Click="EditMenu_Click" Style="{StaticResource DiscordFlyoutItemStyle}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE70F;" FontSize="16"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>

                                <MenuFlyoutItem Text="Pin Message" Style="{StaticResource DiscordFlyoutItemStyle}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE718;" FontSize="16"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <MenuFlyoutItem Text="Mark Unread" Style="{StaticResource DiscordFlyoutItemStyle}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE7C5;" FontSize="16"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <MenuFlyoutItem Text="Copy Message Link" Style="{StaticResource DiscordFlyoutItemStyle}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE71B;" FontSize="16"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>

                                <MenuFlyoutSeparator Style="{StaticResource DiscordFlyoutSeparatorStyle}"/>

                                <MenuFlyoutItem Text="Copy Text" Click="CopyText_Click" Style="{StaticResource DiscordFlyoutItemStyle}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE8C8;" FontSize="16"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>

                                <MenuFlyoutSeparator Style="{StaticResource DiscordFlyoutSeparatorStyle}"/>

                                <MenuFlyoutItem x:Name="DeleteMenuItem" Text="Delete Message" Click="DeleteMenu_Click" Style="{StaticResource DiscordDeleteFlyoutItemStyle}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE74D;" FontSize="16"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <MenuFlyoutItem x:Name="ReportMenuItem" Text="Report Message" Style="{StaticResource DiscordDeleteFlyoutItemStyle}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE7BA;" FontSize="16"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>

                                <MenuFlyoutSeparator Style="{StaticResource DiscordFlyoutSeparatorStyle}"/>

                                <MenuFlyoutItem Text="Copy Message ID" Click="CopyID_Click" Style="{StaticResource DiscordFlyoutItemStyle}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE946;" FontSize="16"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                            </MenuFlyout>
                        </Grid.ContextFlyout>

                        <!-- Background for hover effect -->
                        <Border x:Name="MessageBackground" Grid.RowSpan="2" Grid.ColumnSpan="2" Background="{x:Bind BackgroundBrush, Mode=OneWay}"/>

                        <!-- REPLY HEADER (Reference) - Row 0 -->
                        <Grid Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,0,0,2" Visibility="{x:Bind ReplyVisibility, Mode=OneWay}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="72"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Spine -->
                            <!-- Spine -->
                            <!-- Spine -->
                             <Path Data="M 76,12 H 42 A 6,6 0 0 0 36,18 V 30" 
                                   Stroke="#4E5058" StrokeThickness="2" 
                                   StrokeEndLineCap="Round"
                                   VerticalAlignment="Top" HorizontalAlignment="Left"/>

                            <!-- Content -->
                            <StackPanel Grid.Column="1" Orientation="Horizontal" Opacity="0.64" Spacing="6" VerticalAlignment="Center" Margin="4,0,0,0">
                                <!-- Mini Avatar -->
                                <Ellipse Width="16" Height="16">
                                    <Ellipse.Fill>
                                        <ImageBrush ImageSource="{x:Bind ReplyAvatarUrl}"/>
                                    </Ellipse.Fill>
                                </Ellipse>
                                
                                <!-- Name -->
                                <TextBlock Text="{x:Bind ReplyAuthorName}" FontWeight="Bold" FontSize="13" Foreground="#B5BAC1"/>
                                
                                <!-- Text -->
                                <TextBlock Text="{x:Bind ReplyContent}" FontSize="13" Foreground="#B5BAC1" MaxLines="1" TextTrimming="CharacterEllipsis"/>
                            </StackPanel>
                        </Grid>

                        <!-- Avatar (Visible only if ShowHeader is True) - Row 1 -->
                        <Grid Grid.Row="1" Grid.Column="0" Visibility="{x:Bind HeaderVisibility, Mode=OneWay}" Width="40" Height="40" VerticalAlignment="Top" Margin="16,0,0,0">
                            <Ellipse>
                                <Ellipse.Fill>
                                    <ImageBrush ImageSource="{x:Bind Message.Author.AvatarUrl}"/>
                                </Ellipse.Fill>
                            </Ellipse>
                        </Grid>

                        <!-- Content Column -->
                        <StackPanel Grid.Row="1" Grid.Column="1" VerticalAlignment="Center" Margin="0,2,16,0">
                            <!-- Header (Name + Time) -->
                            <StackPanel Orientation="Horizontal" Spacing="8" Visibility="{x:Bind HeaderVisibility, Mode=OneWay}" Margin="0,2,0,4">
                                <TextBlock Text="{x:Bind Message.Author.DisplayName}" FontWeight="Bold" Foreground="{StaticResource DiscordTextNormal}" FontSize="16"/>
                                <TextBlock Text="{x:Bind TimestampFormatted, Mode=OneWay}" Foreground="{StaticResource DiscordTextMuted}" FontSize="12" VerticalAlignment="Bottom" Margin="0,0,0,2"/>
                            </StackPanel>
                            
                            <!-- Content Text (RichText for Markdown) -->
                            <RichTextBlock xmlns:helpers="using:NativeDiscord.Helpers"
                                           helpers:MarkdownTextHelper.Markdown="{x:Bind Content, Mode=OneWay}" 
                                           helpers:MarkdownTextHelper.IsEdited="{x:Bind IsEdited, Mode=OneWay}"
                                           helpers:MarkdownTextHelper.DiscordService="{x:Bind Service, Mode=OneWay}"
                                           helpers:MarkdownTextHelper.RefreshId="{x:Bind RefreshId, Mode=OneWay}"
                                           helpers:MarkdownTextHelper.CurrentGuildId="{x:Bind CurrentGuildId, Mode=OneWay}"
                                           TextWrapping="Wrap" 
                                           Foreground="{StaticResource DiscordTextNormal}" 
                                           FontSize="15" 
                                           LineHeight="22" 
                                           IsTextSelectionEnabled="True"
                                           Visibility="{x:Bind ContentVisibility, Mode=OneWay}"/>

                            <!-- Edit Box -->
                            <TextBox x:Name="EditTextBox" 
                                      Text="{x:Bind Content, Mode=TwoWay}"
                                      Visibility="{x:Bind EditVisibility, Mode=OneWay}"
                                      AcceptsReturn="True"
                                      TextWrapping="Wrap"
                                      PreviewKeyDown="EditTextBox_PreviewKeyDown"
                                      Style="{StaticResource CustomEditTextBoxStyle}"
                                      Margin="0,4,0,4"
                                      Loaded="EditTextBox_Loaded"/>

                            <!-- Edit Hint -->
                            <TextBlock Text="escape to cancel â€¢ enter to save" 
                                       FontSize="11" 
                                       Foreground="#949BA4"
                                       Visibility="{x:Bind EditVisibility, Mode=OneWay}"
                                       Margin="0,-2,0,4"/>

                            <!-- Attachments -->
                            <ItemsControl ItemsSource="{x:Bind Message.Attachments}" Visibility="{x:Bind AttachmentsVisibility, Mode=OneWay}" Margin="0,4,0,0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="models:Attachment">
                                        <controls:AttachmentControl Attachment="{x:Bind}"/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Embeds -->
                            <ItemsControl ItemsSource="{x:Bind Embeds}" Visibility="{x:Bind EmbedsVisibility, Mode=OneWay}" Margin="0,4,0,0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="local:EmbedViewModel">
                                        <controls:EmbedControl Embed="{x:Bind Embed}" DiscordService="{x:Bind DiscordService}" RefreshId="{x:Bind RefreshId, Mode=OneWay}" CurrentGuildId="{x:Bind CurrentGuildId, Mode=OneWay}"/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Reactions -->
                            <ItemsControl ItemsSource="{x:Bind Reactions, Mode=OneWay}" Visibility="{x:Bind ReactionsVisibility, Mode=OneWay}" Margin="0,4,0,0">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <VariableSizedWrapGrid Orientation="Horizontal" ItemHeight="24"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="models:Reaction">
                                        <controls:ReactionControl Reaction="{x:Bind}" ReactionClicked="OnReactionClicked"/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!-- Hover Toolbar (Action Bar) -->
                        <Border Grid.Row="1" Grid.Column="1" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,-30,16,0"
                                Background="{StaticResource DiscordBackgroundSecondary}"
                                BorderBrush="{StaticResource DiscordBackgroundTertiary}"
                                BorderThickness="1"
                                CornerRadius="4"
                                Padding="2"
                                Visibility="{x:Bind ToolbarVisibility, Mode=OneWay}">
                            <Border.Shadow>
                                <ThemeShadow/>
                            </Border.Shadow>
                            <StackPanel Orientation="Horizontal" Spacing="0">
                                <!-- Quick Reactions -->
                                <Button Style="{StaticResource ActionButtonStyle}" Click="QuickReaction_Click" Tag="ðŸ‘" ToolTipService.ToolTip="Thumbs Up">
                                    <TextBlock Text="ðŸ‘" FontSize="16"/>
                                </Button>
                                <Button Style="{StaticResource ActionButtonStyle}" Click="QuickReaction_Click" Tag="ðŸ˜‚" ToolTipService.ToolTip="Joy">
                                    <TextBlock Text="ðŸ˜‚" FontSize="16"/>
                                </Button>
                                <Button Style="{StaticResource ActionButtonStyle}" Click="QuickReaction_Click" Tag="ðŸ”¥" ToolTipService.ToolTip="Fire">
                                    <TextBlock Text="ðŸ”¥" FontSize="16"/>
                                </Button>
                                
                                <!-- Separator -->
                                <Border Width="1" Height="16" Background="{StaticResource DiscordBackgroundTertiary}" Margin="4,0,4,0" VerticalAlignment="Center"/>

                                <!-- Reaction -->
                                <Button Style="{StaticResource ActionButtonStyle}" Click="ReactionMenu_Click" ToolTipService.ToolTip="Add Reaction">
                                    <FontIcon Glyph="&#xE76E;" FontSize="16" Foreground="{StaticResource DiscordTextNormal}"/>
                                </Button>
                                <!-- Reply (Only if NOT author) -->
                                <Button Style="{StaticResource ActionButtonStyle}" Click="ReplyMenu_Click" ToolTipService.ToolTip="Reply"
                                        Visibility="{x:Bind CanNotModify, Mode=OneWay}">
                                    <FontIcon Glyph="&#xE97A;" FontSize="16" Foreground="{StaticResource DiscordTextNormal}"/>
                                </Button>
                                <!-- Edit (Only if author) -->
                                <Button Style="{StaticResource ActionButtonStyle}" Click="EditMenu_Click" ToolTipService.ToolTip="Edit"
                                        Visibility="{x:Bind CanModify, Mode=OneWay}">
                                    <FontIcon Glyph="&#xE70F;" FontSize="16" Foreground="{StaticResource DiscordTextNormal}"/>
                                </Button>
                                <!-- Forward (Always visible) -->
                                <Button Style="{StaticResource ActionButtonStyle}" Click="ForwardMenu_Click" ToolTipService.ToolTip="Forward">
                                    <FontIcon Glyph="&#xE752;" FontSize="16" Foreground="{StaticResource DiscordTextNormal}"/>
                                </Button>
                                <!-- More (Opens Context Menu) -->
                                <Button Style="{StaticResource ActionButtonStyle}" Click="MoreMenu_Click" ToolTipService.ToolTip="More">
                                    <FontIcon Glyph="&#xE712;" FontSize="16" Foreground="{StaticResource DiscordTextNormal}"/>
                                </Button>
                            </StackPanel>
                        </Border>
                    </Grid>
                </StackPanel>
                </DataTemplate>
            </ListView.ItemTemplate>
            
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    <Setter Property="Padding" Value="0"/>
                    <Setter Property="Margin" Value="0"/>
                    <Setter Property="MinHeight" Value="22"/>
                </Style>
            </ListView.ItemContainerStyle>
            
            <!-- Disable animations to prevent "refresh" feel on new messages -->
            <ListView.ItemContainerTransitions>
                <TransitionCollection/>
            </ListView.ItemContainerTransitions>
        </ListView>
        
        <ProgressRing x:Name="LoadingRing" Grid.Row="1" IsActive="False" HorizontalAlignment="Center" VerticalAlignment="Center"/>

        <!-- Input Area -->
        <StackPanel Grid.Row="2" Background="{StaticResource DiscordBackgroundPrimary}">
            
            <!-- Reply Preview Bar -->
            <Grid x:Name="ReplyPreviewPanel" Background="#2B2D31" Padding="16,8" Visibility="Collapsed" BorderBrush="#26272D" BorderThickness="0,1,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon Glyph="&#xE97A;" Foreground="#B5BAC1" FontSize="14"/>
                    <TextBlock x:Name="ReplyPreviewText" Text="Replying to User" Foreground="#B5BAC1" FontSize="14"/>
                </StackPanel>
                
                <Button Grid.Column="1" Click="ReplyCloseButton_Click" Background="Transparent" Padding="4" BorderThickness="0">
                     <FontIcon Glyph="&#xE711;" FontSize="12" Foreground="#B5BAC1"/>
                </Button>
            </Grid>

            <!-- Typing Indicator -->
             <StackPanel x:Name="TypingIndicatorPanel" Orientation="Horizontal" Margin="16,0,16,4" Visibility="Collapsed">
                 <ProgressRing IsActive="True" Width="12" Height="12" Margin="0,2,8,0" Foreground="{StaticResource DiscordTextNormal}"/>
                 <TextBlock x:Name="TypingIndicatorText" Text="User is typing..." FontSize="12" FontWeight="Bold" Foreground="{StaticResource DiscordTextNormal}"/>
             </StackPanel>

            <Grid Padding="16,0,16,24">
                <Grid Background="#383A40" CornerRadius="8" Height="44">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Plus Icon -->
                    <Button Background="Transparent" BorderThickness="0" Padding="12,0" VerticalAlignment="Stretch">
                        <FontIcon Glyph="&#xE710;" FontSize="16" Foreground="{StaticResource DiscordInteractiveNormal}"/>
                    </Button>

                    <!-- Input Box -->
                    <TextBox x:Name="MessageInput" 
                             Grid.Column="1"
                             PlaceholderText="Message #channel" 
                             Style="{StaticResource DefaultTextBoxStyle}" 
                             BorderThickness="0" 
                             Background="Transparent" 
                             Foreground="{StaticResource DiscordTextNormal}" 
                             FontSize="15"
                             VerticalAlignment="Center"
                             Padding="0,10"
                             PreviewKeyDown="MessageInput_KeyDown"/>
                     
                     <!-- Genric Icons -->
                     <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4" Margin="0,0,8,0">
                         <Button Background="Transparent" BorderThickness="0" Padding="8,0" VerticalAlignment="Stretch">
                            <FontIcon Glyph="&#xED54;" FontSize="20" Foreground="{StaticResource DiscordInteractiveNormal}"/>
                         </Button>
                         <Button Background="Transparent" BorderThickness="0" Padding="8,0" VerticalAlignment="Stretch">
                            <FontIcon Glyph="&#xE76E;" FontSize="20" Foreground="{StaticResource DiscordInteractiveNormal}"/>
                         </Button>
                         <Button Background="Transparent" BorderThickness="0" Padding="8,0" VerticalAlignment="Stretch">
                            <FontIcon Glyph="&#xE76E;" FontSize="20" Foreground="{StaticResource DiscordInteractiveNormal}"/>
                         </Button>
                     </StackPanel>
                </Grid>
            </Grid>
        </StackPanel>
        
        <!-- RIGHT SIDEBAR (USER PROFILE) -->
        <Grid x:Name="UserProfileSidebar" Grid.Row="0" Grid.RowSpan="3" Grid.Column="1" Width="340" Background="#232428" BorderBrush="#26272D" BorderThickness="1,0,0,0" Visibility="Collapsed">
             <Grid.RowDefinitions>
                 <RowDefinition Height="Auto"/> <!-- Banner -->
                 <RowDefinition Height="*"/>    <!-- Content -->
             </Grid.RowDefinitions>
             
             <!-- Banner Color (Mock) -->
             <Grid Height="120" Background="{StaticResource ApplicationPageBackgroundThemeBrush}">
                 <Rectangle Fill="#111214" Opacity="0.5"/> 
                 <!-- If we had banner URL, ImageBrush here -->
             </Grid>
             
             <ScrollViewer Grid.Row="1" Margin="0,-40,0,0">
                 <StackPanel Padding="16">
                     <!-- Avatar Circle -->
                     <Grid Width="80" Height="80" HorizontalAlignment="Left" Margin="0,0,0,8">
                         <Grid Width="88" Height="88" Margin="-4"> <!-- Border Container -->
                            <Ellipse Fill="#232428"/>
                         </Grid>
                         <Ellipse>
                             <Ellipse.Fill>
                                 <ImageBrush ImageSource="{x:Bind SidebarUser.AvatarUrl, Mode=OneWay}"/>
                             </Ellipse.Fill>
                         </Ellipse>
                         <Ellipse Width="16" Height="16" Fill="#23A559" Stroke="#232428" StrokeThickness="3" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="4,4"/>
                     </Grid>
                     
                     <TextBlock Text="{x:Bind SidebarUser.DisplayName, Mode=OneWay}" FontSize="20" FontWeight="Bold" Foreground="White" Margin="0,4,0,0"/>
                     <TextBlock Text="{x:Bind SidebarUser.Username, Mode=OneWay}" FontSize="14" Foreground="#DBDEE1" Margin="0,0,0,16"/>
                     
                     <!-- Divider -->
                     <Rectangle Height="1" Fill="#3F4147" Margin="0,0,0,16"/>
                     
                     <!-- Member Since -->
                     <TextBlock Text="MEMBER SINCE" FontSize="11" FontWeight="Bold" Foreground="#949BA4" Margin="0,0,0,8"/>
                     <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,0,0,16">
                         <FontIcon Glyph="&#xE74C;" FontSize="16" Foreground="#B5BAC1"/> 
                         <TextBlock Text="Feb 24, 2017" Foreground="#DBDEE1"/> 
                     </StackPanel>
                     
                     <!-- Note -->
                     <TextBlock Text="NOTE" FontSize="11" FontWeight="Bold" Foreground="#949BA4" Margin="0,0,0,8"/>
                     <TextBox PlaceholderText="Click to add a note" Height="32" Background="Transparent" Foreground="#DBDEE1" BorderThickness="0" Padding="0"/>
                     
                 </StackPanel>
             </ScrollViewer>
        </Grid>
    </Grid>
</Page>
