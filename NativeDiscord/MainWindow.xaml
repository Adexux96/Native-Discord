<Window
    x:Class="NativeDiscord.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:NativeDiscord.Models"
    xmlns:local="using:NativeDiscord"
    mc:Ignorable="d">

    <Grid Background="{StaticResource DiscordBackgroundTertiary}" KeyDown="RootGrid_KeyDown">
        <Grid.Resources>
            <local:BoolToVisibilityConverter x:Key="BoolToVis"/>
        </Grid.Resources>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Custom Title Bar -->
            <RowDefinition Height="*"/>    <!-- Content -->
        </Grid.RowDefinitions>

        <!-- Custom Title Bar -->
        <Grid x:Name="AppTitleBar" Height="32" Background="{StaticResource DiscordBackgroundTertiary}">
            <TextBlock Text="Discord" VerticalAlignment="Center" Margin="16,0,0,0" FontSize="12" FontWeight="Bold" Foreground="#949BA4" IsHitTestVisible="False"/>
        </Grid>

        <!-- Main Layout -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="72"/> <!-- Server Rail -->
                <ColumnDefinition Width="*"/>  <!-- App Content -->
            </Grid.ColumnDefinitions>

            <!-- Server Rail -->
            <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Hidden">
                <StackPanel Spacing="8" Padding="0,12">
                    <!-- Home / Friends Button -->
                    <Button x:Name="HomeButton" Click="HomeButton_Click" Width="48" Height="48" CornerRadius="24" Background="#313338" Padding="0" Margin="12,0">
                        <Button.Content>
                            <FontIcon Glyph="&#xE779;" FontSize="20" Foreground="{StaticResource DiscordInteractiveNormal}"/> <!-- Discord Logoish -->
                        </Button.Content>
                        <ToolTipService.ToolTip>
                            <ToolTip Content="Direct Messages"/>
                        </ToolTipService.ToolTip>
                    </Button>
                    
                    <Border Height="2" Width="32" Background="#35363C"/>

                    <!-- Server List -->
                    <ListView x:Name="ServerList" SelectionMode="Single" SelectionChanged="ServerList_SelectionChanged">
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="Margin" Value="0,4"/>
                                <Setter Property="MinWidth" Value="0"/>
                                <Setter Property="MinHeight" Value="48"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListViewItem">
                                            <Grid x:Name="RootGrid" Background="Transparent">
                                                <VisualStateManager.VisualStateGroups>
                                                    <VisualStateGroup x:Name="CommonStates">
                                                        <VisualState x:Name="Normal" />
                                                        <VisualState x:Name="PointerOver">
                                                            <Storyboard>
                                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="Pill" Storyboard.TargetProperty="Height">
                                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="20"/>
                                                                </ObjectAnimationUsingKeyFrames>
                                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="Pill" Storyboard.TargetProperty="Opacity">
                                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="1"/>
                                                                </ObjectAnimationUsingKeyFrames>
                                                                 <ObjectAnimationUsingKeyFrames Storyboard.TargetName="IconRect" Storyboard.TargetProperty="CornerRadius">
                                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="16"/>
                                                                </ObjectAnimationUsingKeyFrames>
                                                            </Storyboard>
                                                        </VisualState>
                                                        <VisualState x:Name="Pressed" />
                                                        <VisualState x:Name="Selected">
                                                            <Storyboard>
                                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="Pill" Storyboard.TargetProperty="Height">
                                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="40"/>
                                                                </ObjectAnimationUsingKeyFrames>
                                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="Pill" Storyboard.TargetProperty="Opacity">
                                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="1"/>
                                                                </ObjectAnimationUsingKeyFrames>
                                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="IconRect" Storyboard.TargetProperty="CornerRadius">
                                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="16"/>
                                                                </ObjectAnimationUsingKeyFrames>
                                                                <!-- Discord does NOT tint the background blue on selection, only the pill is white/visible -->
                                                                <!-- Removed SelectionIndicator animation -->
                                                            </Storyboard>
                                                        </VisualState>
                                                    </VisualStateGroup>
                                                </VisualStateManager.VisualStateGroups>

                                                <!-- The Layout -->
                                                <Grid Height="48" Width="72">
                                                    <!-- Pill Indicator -->
                                                    <Rectangle x:Name="Pill" Width="4" Height="8" HorizontalAlignment="Left" Margin="0" Fill="White" RadiusX="2" RadiusY="2" Opacity="0" VerticalAlignment="Center"/>
                                                    
                                                    <!-- Icon Container -->
                                                    <Grid Width="48" Height="48" Margin="12,0">
                                                        <!-- No Background Selection -->
                                                        
                                                        <!-- The Icon itself -->
                                                        <!-- Note: We bind to the specific properties in ContentPresenter -->
                                                        <Border x:Name="IconRect" Width="48" Height="48" CornerRadius="24" Background="#313338"> <!-- Circle by default -->
                                                            <ContentPresenter />
                                                        </Border>
                                                    </Grid>
                                                </Grid>
                                            </Grid>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListView.ItemContainerStyle>
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="models:Server">
                                <Grid>
                                    <Image Source="{x:Bind IconUrl}" Stretch="UniformToFill"/>
                                    <ToolTipService.ToolTip>
                                        <ToolTip Content="{x:Bind Name}"/>
                                    </ToolTipService.ToolTip>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                    
                    <Button Width="48" Height="48" CornerRadius="24" Background="#313338" Padding="0" Margin="12,0">
                        <FontIcon Glyph="&#xE710;" FontSize="24" Foreground="#23A559"/> <!-- Green Plus -->
                    </Button>
                </StackPanel>
            </ScrollViewer>

            <!-- App Content -->
            <Frame x:Name="ContentFrame" Grid.Column="1" Background="{StaticResource DiscordBackgroundPrimary}">
                 <!-- Default content -->
            </Frame>
        </Grid>

        
        <!-- Search Overlay -->
        <Grid x:Name="SearchOverlay" Visibility="Collapsed" Grid.RowSpan="2">
            <Grid.Background>
                <SolidColorBrush Color="Black" Opacity="0.5"/>
            </Grid.Background>
            
            <Border Width="570" Height="400" Background="#313338" CornerRadius="8" VerticalAlignment="Center" HorizontalAlignment="Center">
                <Border.Shadow>
                    <ThemeShadow />
                </Border.Shadow>
                <Grid>
                    <Grid.RowDefinitions>
                         <RowDefinition Height="Auto"/>
                         <RowDefinition Height="*"/>
                         <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Search Input -->
                    <TextBox x:Name="SearchBox" 
                             PlaceholderText="Where would you like to go?" 
                             Margin="20" 
                             Height="50" 
                             FontSize="20"
                             BorderThickness="0"
                             Background="Transparent"
                             TextChanged="SearchBox_TextChanged"/>
                             
                    
                    
                    <!-- Results -->
                    <ListView x:Name="SearchList" Grid.Row="1" ItemsSource="{x:Bind SearchResults}" ItemClick="SearchList_ItemClick" IsItemClickEnabled="True" SelectionMode="None">
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="Padding" Value="10,5"/>
                                <Setter Property="Margin" Value="10,2"/>
                            </Style>
                        </ListView.ItemContainerStyle>
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="models:SearchResultItem">
                                <Grid Height="40">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <Grid Width="32" Height="32" Margin="0,0,10,0">
                                        <Ellipse Fill="#313338" /> 
                                        
                                        <!-- Image -->
                                        <Border CornerRadius="16" Visibility="{Binding ShowImage, Converter={StaticResource BoolToVis}}">
                                            <Image Source="{Binding IconUrl}" Stretch="UniformToFill"/>
                                        </Border>

                                        <!-- Glyph -->
                                        <FontIcon Glyph="{x:Bind Glyph}" FontSize="16" Foreground="#949BA4" 
                                                  Visibility="{Binding ShowGlyph, Converter={StaticResource BoolToVis}}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Grid>
                                    
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock Text="{x:Bind Title}" Foreground="White" FontWeight="SemiBold"/>
                                        <TextBlock Text="{x:Bind Subtitle}" Foreground="#B5BAC1" FontSize="12"/>
                                    </StackPanel>
                                    
                                    <TextBlock Grid.Column="2" Text="{x:Bind Type}" Foreground="#949BA4" FontSize="10" VerticalAlignment="Center"/>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                    
                    <!-- Footer -->
                    <Border Grid.Row="2" Background="#2B2D31" Height="30" CornerRadius="0,0,8,8" Padding="10,0">
                         <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="10">
                             <TextBlock Text="PROTIP:" Foreground="#23A559" FontWeight="Bold" FontSize="10"/>
                             <TextBlock Text="Start searches with @ # ! * to narrow results." Foreground="#949BA4" FontSize="10"/>
                         </StackPanel>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Window>
